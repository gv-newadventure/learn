using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Remap.Core.Abstractions;
using Remap.Core.Services;
using Remap.Infrastructure.Configuration;
using Remap.Infrastructure.Data;
using Serilog;

var builder = Host.CreateApplicationBuilder(args);

// --- Options ---
builder.Services.Configure<InfrastructureOptions>(
    builder.Configuration.GetSection("Infrastructure"));
builder.Services.Configure<RemapOptions>(
    builder.Configuration.GetSection("Remap"));

// --- EF Core DbContext ---
builder.Services.AddDbContext<RemapDbContext>(options =>
    options.UseSqlServer(
        builder.Configuration.GetSection("Infrastructure")["MainConnectionString"])
);

// --- DI registrations (SCOPED, not singleton!) ---
builder.Services.AddScoped<IRemapRepository, SqlRemapRepository>();
builder.Services.AddScoped<IRemapTransformer, PositionalXmlTransformer>();
builder.Services.AddScoped<IRemapOrchestrator, RemapOrchestrator>();

// Hosted worker
builder.Services.AddHostedService<RemapWorker>();

// --- Serilog basic console logger (no ReadFrom.Configuration) ---
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Information()
    .Enrich.FromLogContext()
    .WriteTo.Console()
    .CreateLogger();

builder.Logging.ClearProviders();
builder.Logging.AddSerilog(Log.Logger, dispose: true);

var host = builder.Build();
await host.RunAsync();
